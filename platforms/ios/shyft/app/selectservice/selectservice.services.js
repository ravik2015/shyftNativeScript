"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var http_1 = require("@angular/http");
var ApplicationSettings = require("application-settings");
var Observable_1 = require("rxjs/Observable");
require("rxjs/add/operator/do");
require("rxjs/add/operator/map");
var utils = require("../shared/utils");
var angular2_uuid_1 = require("angular2-uuid");
require("rxjs/add/observable/of");
var SelectService = (function () {
    function SelectService(http) {
        this.http = http;
        this.servicesSelections = Array();
        this.test = Array();
        var date = new Date();
        var isoDate = date.toISOString();
        this.customerAppointment = {
            "id": "",
            "datetime": isoDate,
            "status": "Pending",
            "vendor": ""
        };
    }
    //---------------------- Service GET Request ----------------------------//
    SelectService.prototype.servicesGet = function (ID) {
        this.vendorID = ID.replace(/["']/g, "");
        var ServiceGetUrl = utils.baseurl + "vendor/" + this.vendorID;
        var headers = this.servicesHeader();
        return this.http.get(ServiceGetUrl, { headers: headers })
            .map(function (res) {
            // If request fails, throw an Error that will be caught
            if (res.status < 200 || res.status >= 300) {
                throw new Error('This request has failed ' + res.status);
            }
            else {
                return res.json();
            }
        });
    };
    SelectService.prototype.servicesHeader = function () {
        this.id_token = JSON.parse(ApplicationSettings.getString("TOKEN", "{}"));
        var headers = new http_1.Headers();
        headers.append("Authorization", this.id_token);
        headers.append("Content-Type", "application/json");
        return headers;
    };
    SelectService.prototype.createCustomerAppointment = function (uuid, vendorId) {
        this.customerAppointment.id = uuid;
        this.customerAppointment.vendor = vendorId;
        console.log("uuid: ", uuid, "vendorId: ", " this.customerAppointment: ", JSON.stringify(this.customerAppointment));
        return Observable_1.Observable.of(this.customerAppointment);
    };
    SelectService.prototype.createAppointment = function (uuid, vendorId, date) {
        var _this = this;
        console.log("appointmentid : ", uuid, "vendorid", vendorId, "date : ", date);
        ApplicationSettings.setString("appointmentid", JSON.stringify(uuid));
        this.appointmentid = uuid;
        var appointmentCreateURL = "https://uat.futuredms.com/shyft-api/appointment/" + this.appointmentid;
        // if (isIOS) {     
        //     this.id_token = localStorage.getItem("IOSToken")
        //             }
        // else
        // {
        //     this.id_token = JSON.parse(ApplicationSettings.getString("TOKEN","{}"))            
        // }
        this.id_token = JSON.parse(ApplicationSettings.getString("TOKEN", "{}"));
        var headers = new http_1.Headers();
        var appointment = {
            "id": this.appointmentid,
            "datetime": date,
            "status": "Pending",
            "vendor": vendorId
        };
        console.log("Appointment Create Url --> ", appointmentCreateURL);
        console.log("Appointment PUT Data Testing-----> ", JSON.stringify(appointment));
        headers.append("Authorization", this.id_token);
        return this.http.put(appointmentCreateURL, appointment, { headers: headers })
            .subscribe(function (result) {
            console.log("Appointment Create Success : ", (JSON.stringify(result)));
            var services = JSON.parse(ApplicationSettings.getString("servicesSelections"));
            services.map(function (item) {
                console.log("Service parse are : ", JSON.stringify(item));
            });
        }, function (error) {
            console.log("Appointment Create Error : ", error);
            _this.vehicleAdd();
            var services = JSON.parse(ApplicationSettings.getString("servicesSelections"));
            services.map(function (item) {
                console.log("service are", item.service);
                _this.serviceAdd(item.service);
            });
        });
    };
    SelectService.prototype.handleErrors = function (error) {
        console.log(JSON.stringify(error.json()));
        return Observable_1.Observable.throw(error);
    };
    SelectService.prototype.serviceAdd = function (servicesId) {
        var serviceid = angular2_uuid_1.UUID.UUID();
        var serviceSelectionURL = "https://uat.futuredms.com/shyft-api/appointment/" + this.appointmentid + "/service-selection/" + serviceid;
        this.id_token = JSON.parse(ApplicationSettings.getString("TOKEN", "{}"));
        var headers = new http_1.Headers();
        headers.append("Authorization", this.id_token);
        ;
        var serviceBody = {
            "id": serviceid,
            "status": "pending",
            "service": servicesId
        };
        return this.http.put(serviceSelectionURL, serviceBody, { headers: headers })
            .subscribe(function (result) {
            console.log("Service added to Appointment : ", JSON.stringify(result));
        }, function (error) {
            console.log("Service add Error : ", error);
        });
    };
    SelectService.prototype.addServiceSelectionIntoAppointment = function (servicesSelection) {
        this.customerAppointment.serviceSelections = servicesSelection;
    };
    SelectService.prototype.getCustomerAppointment = function () {
        return Observable_1.Observable.of(this.customerAppointment);
    };
    SelectService.prototype.addServiceSelection = function (serviceSelection) {
        this.servicesSelections.push(serviceSelection);
        this.customerAppointment.serviceSelections.push(serviceSelection);
    };
    SelectService.prototype.getServicesSelections = function () {
        console.log("this.selectService.getServicesSelections()", this.servicesSelections);
        return this.servicesSelections;
    };
    SelectService.prototype.serviceSelection = function (serviceID, uuid) {
        this.serviceID = serviceID;
        this.appointmentid = uuid;
        var serviceid = angular2_uuid_1.UUID.UUID();
        var serviceBody = {
            "id": serviceid,
            "status": "pending",
            "service": this.serviceID
        };
        this.servicesSelections.push(serviceBody);
        this.customerAppointment.serviceSelections = this.servicesSelections;
        ApplicationSettings.setString("servicesSelections", JSON.stringify(this.servicesSelections));
    };
    SelectService.prototype.vehicleAdd = function () {
        var vehicleUUID = angular2_uuid_1.UUID.UUID();
        var vehicleaddURL = "https://uat.futuredms.com/shyft-api/appointment/" + this.appointmentid + "/vehicle";
        // if (isIOS) {     
        //     this.id_token = localStorage.getItem("IOSToken")
        //             }
        // else
        // {
        //     this.id_token = JSON.parse(ApplicationSettings.getString("TOKEN","{}"))            
        // }
        this.id_token = JSON.parse(ApplicationSettings.getString("TOKEN", "{}"));
        var headers = new http_1.Headers();
        var date = new Date();
        var isoDate = date.toISOString();
        console.log(" this is my iso date ------> ", isoDate);
        var vehicleadd = {
            "id": vehicleUUID,
            "vehicleId": JSON.parse(ApplicationSettings.getString("vehicleid")),
            "miles": 123
        };
        console.log("vehicleadd create url --> ", vehicleaddURL);
        console.log("vehicleadd PUT Data Testing-----> ", JSON.stringify(vehicleadd));
        headers.append("Authorization", this.id_token);
        return this.http.put(vehicleaddURL, vehicleadd, { headers: headers })
            .subscribe(function (result) {
            console.log("Vehicle Add Success ------------> ", JSON.stringify(result));
        }, function (error) {
            console.log("Vehicle Add Error ------------>", error);
        });
    };
    SelectService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [http_1.Http])
    ], SelectService);
    return SelectService;
}());
exports.SelectService = SelectService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0c2VydmljZS5zZXJ2aWNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNlbGVjdHNlcnZpY2Uuc2VydmljZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMkM7QUFDM0Msc0NBQXdFO0FBRXhFLDBEQUE0RDtBQUM1RCw4Q0FBNEM7QUFDNUMsZ0NBQThCO0FBQzlCLGlDQUErQjtBQUMvQix1Q0FBeUM7QUFDekMsK0NBQXFDO0FBR3JDLGtDQUFnQztBQUloQztJQVVJLHVCQUFvQixJQUFVO1FBQVYsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUp2Qix1QkFBa0IsR0FBRyxLQUFLLEVBQUUsQ0FBQztRQUU3QixTQUFJLEdBQUcsS0FBSyxFQUFFLENBQUM7UUFHbEIsSUFBSSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN0QixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDakMsSUFBSSxDQUFDLG1CQUFtQixHQUFHO1lBQ3ZCLElBQUksRUFBRSxFQUFFO1lBQ1IsVUFBVSxFQUFFLE9BQU87WUFDbkIsUUFBUSxFQUFFLFNBQVM7WUFDbkIsUUFBUSxFQUFFLEVBQUU7U0FDZixDQUFBO0lBQ0osQ0FBQztJQUdGLDJFQUEyRTtJQUVwRSxtQ0FBVyxHQUFsQixVQUFtQixFQUFFO1FBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFDdkMsSUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDLE9BQU8sR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUM5RCxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDcEMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsQ0FBQzthQUN4RCxHQUFH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Q1YsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLENBQ3ZCO2FBQ1IsU0FBUyxDQUFDLFVBQUMsTUFBTTtZQUNkLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO1FBQzdFLENBQUMsRUFBRSxVQUFDLEtBQUs7WUFDTCxPQUFPLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxFQUFFLEtBQUssQ0FBQyxDQUFBO1FBQ3pELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQXpNSSxhQUFhO1FBRHpCLGlCQUFVLEVBQUU7eUNBV2lCLFdBQUk7T0FWckIsYUFBYSxDQTRNekI7SUFBRCxvQkFBQztDQUFBLEFBNU1ELElBNE1DO0FBNU1ZLHNDQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBIdHRwLCBIZWFkZXJzLCBSZXNwb25zZSwgUmVxdWVzdE9wdGlvbnMgfSBmcm9tIFwiQGFuZ3VsYXIvaHR0cFwiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSBhcyBSeE9ic2VydmFibGUgfSBmcm9tIFwicnhqcy9PYnNlcnZhYmxlXCI7XG5pbXBvcnQgKiBhcyBBcHBsaWNhdGlvblNldHRpbmdzIGZyb20gXCJhcHBsaWNhdGlvbi1zZXR0aW5nc1wiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSdcbmltcG9ydCBcInJ4anMvYWRkL29wZXJhdG9yL2RvXCI7XG5pbXBvcnQgXCJyeGpzL2FkZC9vcGVyYXRvci9tYXBcIjtcbmltcG9ydCAqIGFzIHV0aWxzIGZyb20gJy4uL3NoYXJlZC91dGlscyc7XG5pbXBvcnQgeyBVVUlEIH0gZnJvbSAnYW5ndWxhcjItdXVpZCc7XG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50JztcbmltcG9ydCB7IGlzQW5kcm9pZCwgaXNJT1MsIGRldmljZSwgc2NyZWVuIH0gZnJvbSBcInBsYXRmb3JtXCI7XG5pbXBvcnQgJ3J4anMvYWRkL29ic2VydmFibGUvb2YnO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTZWxlY3RTZXJ2aWNlIHtcbiAgICBwdWJsaWMgaWRfdG9rZW47XG4gICAgcHVibGljIHNlcnZpY2VJRDtcbiAgICBwdWJsaWMgdmVuZG9ySUQ7XG4gICAgcHVibGljIGFwcG9pbnRtZW50aWQ7XG4gICAgcHVibGljIGN1c3RvbWVyQXBwb2ludG1lbnQ7XG4gICAgcHVibGljIHNlcnZpY2VzU2VsZWN0aW9ucyA9IEFycmF5KCk7XG5cbiAgICBwdWJsaWMgdGVzdCA9IEFycmF5KCk7XG4gICAgXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwKSB7XG4gICAgICAgIGxldCBkYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgbGV0IGlzb0RhdGUgPSBkYXRlLnRvSVNPU3RyaW5nKCk7XG4gICAgICAgIHRoaXMuY3VzdG9tZXJBcHBvaW50bWVudCA9IHtcbiAgICAgICAgICAgIFwiaWRcIjogXCJcIixcbiAgICAgICAgICAgIFwiZGF0ZXRpbWVcIjogaXNvRGF0ZSxcbiAgICAgICAgICAgIFwic3RhdHVzXCI6IFwiUGVuZGluZ1wiLFxuICAgICAgICAgICAgXCJ2ZW5kb3JcIjogXCJcIlxuICAgICAgICB9XG4gICAgIH1cbiAgICAgXG5cbiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gU2VydmljZSBHRVQgUmVxdWVzdCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLy9cblxuICAgIHB1YmxpYyBzZXJ2aWNlc0dldChJRCkge1xuICAgICAgICB0aGlzLnZlbmRvcklEID0gSUQucmVwbGFjZSgvW1wiJ10vZywgXCJcIilcbiAgICAgICAgbGV0IFNlcnZpY2VHZXRVcmwgPSB1dGlscy5iYXNldXJsICsgXCJ2ZW5kb3IvXCIgKyB0aGlzLnZlbmRvcklEO1xuICAgICAgICBsZXQgaGVhZGVycyA9IHRoaXMuc2VydmljZXNIZWFkZXIoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoU2VydmljZUdldFVybCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pXG4gICAgICAgIC5tYXAocmVzID0+IHtcbiAgICAgICAgICAgIC8vIElmIHJlcXVlc3QgZmFpbHMsIHRocm93IGFuIEVycm9yIHRoYXQgd2lsbCBiZSBjYXVnaHRcbiAgICAgICAgICAgIGlmKHJlcy5zdGF0dXMgPCAyMDAgfHwgcmVzLnN0YXR1cyA+PSAzMDApIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGlzIHJlcXVlc3QgaGFzIGZhaWxlZCAnICsgcmVzLnN0YXR1cyk7XG4gICAgICAgICAgICB9IFxuICAgICAgICAgICAgLy8gSWYgZXZlcnl0aGluZyB3ZW50IGZpbmUsIHJldHVybiB0aGUgcmVzcG9uc2VcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgIH1cblxuICAgIHByaXZhdGUgc2VydmljZXNIZWFkZXIoKSB7XG4gICAgXG4gICAgICAgIHRoaXMuaWRfdG9rZW4gPSBKU09OLnBhcnNlKEFwcGxpY2F0aW9uU2V0dGluZ3MuZ2V0U3RyaW5nKFwiVE9LRU5cIixcInt9XCIpKSAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IGhlYWRlcnMgPSBuZXcgSGVhZGVycygpO1xuICAgICAgICBoZWFkZXJzLmFwcGVuZChcIkF1dGhvcml6YXRpb25cIiwgdGhpcy5pZF90b2tlbik7XG4gICAgICAgIGhlYWRlcnMuYXBwZW5kKFwiQ29udGVudC1UeXBlXCIsIFwiYXBwbGljYXRpb24vanNvblwiKTtcbiAgICAgICAgcmV0dXJuIGhlYWRlcnM7XG4gICAgfVxuXG4gICAgY3JlYXRlQ3VzdG9tZXJBcHBvaW50bWVudCh1dWlkLCB2ZW5kb3JJZCl7XG4gICAgICAgIHRoaXMuY3VzdG9tZXJBcHBvaW50bWVudC5pZCA9IHV1aWQ7XG4gICAgICAgdGhpcy5jdXN0b21lckFwcG9pbnRtZW50LnZlbmRvciA9IHZlbmRvcklkO1xuICAgICAgIGNvbnNvbGUubG9nKFwidXVpZDogXCIsIHV1aWQsIFwidmVuZG9ySWQ6IFwiLCBcIiB0aGlzLmN1c3RvbWVyQXBwb2ludG1lbnQ6IFwiLCBKU09OLnN0cmluZ2lmeSh0aGlzLmN1c3RvbWVyQXBwb2ludG1lbnQpIClcbiAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5vZih0aGlzLmN1c3RvbWVyQXBwb2ludG1lbnQpXG4gICAgIH1cbiAgICAgXG4gICAgcHVibGljIGNyZWF0ZUFwcG9pbnRtZW50KHV1aWQsIHZlbmRvcklkLCBkYXRlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiYXBwb2ludG1lbnRpZCA6IFwiLCB1dWlkLCBcInZlbmRvcmlkXCIsIHZlbmRvcklkLCBcImRhdGUgOiBcIiwgZGF0ZSApXG4gICAgICAgIEFwcGxpY2F0aW9uU2V0dGluZ3Muc2V0U3RyaW5nKFwiYXBwb2ludG1lbnRpZFwiLCBKU09OLnN0cmluZ2lmeSh1dWlkKSlcbiAgICAgICAgdGhpcy5hcHBvaW50bWVudGlkID0gdXVpZFxuICAgICAgICBsZXQgYXBwb2ludG1lbnRDcmVhdGVVUkwgPSBcImh0dHBzOi8vdWF0LmZ1dHVyZWRtcy5jb20vc2h5ZnQtYXBpL2FwcG9pbnRtZW50L1wiICsgdGhpcy5hcHBvaW50bWVudGlkO1xuICAgICAgICAvLyBpZiAoaXNJT1MpIHsgICAgIFxuICAgICAgICAvLyAgICAgdGhpcy5pZF90b2tlbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwiSU9TVG9rZW5cIilcbiAgICAgICAgLy8gICAgICAgICAgICAgfVxuICAgICAgICAvLyBlbHNlXG4gICAgICAgIC8vIHtcbiAgICAgICAgLy8gICAgIHRoaXMuaWRfdG9rZW4gPSBKU09OLnBhcnNlKEFwcGxpY2F0aW9uU2V0dGluZ3MuZ2V0U3RyaW5nKFwiVE9LRU5cIixcInt9XCIpKSAgICAgICAgICAgIFxuICAgICAgICAvLyB9XG4gICAgICAgIHRoaXMuaWRfdG9rZW4gPSBKU09OLnBhcnNlKEFwcGxpY2F0aW9uU2V0dGluZ3MuZ2V0U3RyaW5nKFwiVE9LRU5cIixcInt9XCIpKSAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IGhlYWRlcnMgPSBuZXcgSGVhZGVycygpO1xuICAgICAgIGxldCAgYXBwb2ludG1lbnQgPSB7XG4gICAgICAgICAgICBcImlkXCI6IHRoaXMuYXBwb2ludG1lbnRpZCxcbiAgICAgICAgICAgIFwiZGF0ZXRpbWVcIjogZGF0ZSxcbiAgICAgICAgICAgIFwic3RhdHVzXCI6IFwiUGVuZGluZ1wiLFxuICAgICAgICAgICAgXCJ2ZW5kb3JcIjogdmVuZG9ySWRcbiAgICAgICAgfTtcbiAgICAgICAgY29uc29sZS5sb2coXCJBcHBvaW50bWVudCBDcmVhdGUgVXJsIC0tPiBcIixhcHBvaW50bWVudENyZWF0ZVVSTCkgICAgICAgIFxuICAgICAgICBjb25zb2xlLmxvZyhcIkFwcG9pbnRtZW50IFBVVCBEYXRhIFRlc3RpbmctLS0tLT4gXCIsIEpTT04uc3RyaW5naWZ5KGFwcG9pbnRtZW50KSk7XG4gICAgICAgIGhlYWRlcnMuYXBwZW5kKFwiQXV0aG9yaXphdGlvblwiLCB0aGlzLmlkX3Rva2VuKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQoXG4gICAgICAgICAgICAgICAgICAgIGFwcG9pbnRtZW50Q3JlYXRlVVJMLFxuICAgICAgICAgICAgICAgICAgICBhcHBvaW50bWVudCxcbiAgICAgICAgICAgICAgICAgICAgeyBoZWFkZXJzOiBoZWFkZXJzIH1cbiAgICAgICAgICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkFwcG9pbnRtZW50IENyZWF0ZSBTdWNjZXNzIDogXCIsIChKU09OLnN0cmluZ2lmeShyZXN1bHQpKSlcbiAgICAgICAgICAgICAgICAgICAgbGV0IHNlcnZpY2VzID0gSlNPTi5wYXJzZShBcHBsaWNhdGlvblNldHRpbmdzLmdldFN0cmluZyhcInNlcnZpY2VzU2VsZWN0aW9uc1wiKSlcbiAgICAgICAgICAgICAgICAgICAgc2VydmljZXMubWFwKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlNlcnZpY2UgcGFyc2UgYXJlIDogXCIsIEpTT04uc3RyaW5naWZ5KGl0ZW0pKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkFwcG9pbnRtZW50IENyZWF0ZSBFcnJvciA6IFwiLCBlcnJvcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnZlaGljbGVBZGQoKSAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHNlcnZpY2VzID0gSlNPTi5wYXJzZShBcHBsaWNhdGlvblNldHRpbmdzLmdldFN0cmluZyhcInNlcnZpY2VzU2VsZWN0aW9uc1wiKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJ2aWNlcy5tYXAoKGl0ZW0pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzZXJ2aWNlIGFyZVwiLGl0ZW0uc2VydmljZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlQWRkKGl0ZW0uc2VydmljZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBoYW5kbGVFcnJvcnMoZXJyb3I6IFJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KGVycm9yLmpzb24oKSkpO1xuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhlcnJvcik7XG4gICAgfVxuXG4gICAgc2VydmljZUFkZChzZXJ2aWNlc0lkKXtcbiAgICAgICAgbGV0IHNlcnZpY2VpZCA9IFVVSUQuVVVJRCgpOyAgICAgICAgXG4gICAgICAgIGxldCBzZXJ2aWNlU2VsZWN0aW9uVVJMID0gXCJodHRwczovL3VhdC5mdXR1cmVkbXMuY29tL3NoeWZ0LWFwaS9hcHBvaW50bWVudC9cIiArIHRoaXMuYXBwb2ludG1lbnRpZCArIFwiL3NlcnZpY2Utc2VsZWN0aW9uL1wiICsgc2VydmljZWlkO1xuXG4gICAgICAgIHRoaXMuaWRfdG9rZW4gPSBKU09OLnBhcnNlKEFwcGxpY2F0aW9uU2V0dGluZ3MuZ2V0U3RyaW5nKFwiVE9LRU5cIixcInt9XCIpKSAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IGhlYWRlcnMgPSBuZXcgSGVhZGVycygpO1xuICAgICAgICBoZWFkZXJzLmFwcGVuZChcIkF1dGhvcml6YXRpb25cIiwgdGhpcy5pZF90b2tlbik7O1xuICAgICAgICBsZXQgc2VydmljZUJvZHkgPSB7XG4gICAgICAgICAgICBcImlkXCI6IHNlcnZpY2VpZCxcbiAgICAgICAgICAgIFwic3RhdHVzXCI6IFwicGVuZGluZ1wiLFxuICAgICAgICAgICAgXCJzZXJ2aWNlXCI6IHNlcnZpY2VzSWRcbiAgICAgICAgfSAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucHV0KFxuICAgICAgICAgICAgc2VydmljZVNlbGVjdGlvblVSTCxcbiAgICAgICAgICAgIHNlcnZpY2VCb2R5LFxuICAgICAgICAgICAgeyBoZWFkZXJzOiBoZWFkZXJzIH1cbiAgICAgICAgKVxuICAgICAgICAuc3Vic2NyaWJlKChyZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU2VydmljZSBhZGRlZCB0byBBcHBvaW50bWVudCA6IFwiLCBKU09OLnN0cmluZ2lmeShyZXN1bHQpKVxuICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiU2VydmljZSBhZGQgRXJyb3IgOiBcIiwgZXJyb3IpXG4gICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgYWRkU2VydmljZVNlbGVjdGlvbkludG9BcHBvaW50bWVudChzZXJ2aWNlc1NlbGVjdGlvbil7XG4gICAgICAgIHRoaXMuY3VzdG9tZXJBcHBvaW50bWVudC5zZXJ2aWNlU2VsZWN0aW9ucyA9IHNlcnZpY2VzU2VsZWN0aW9uO1xuICAgIH1cbiAgICBcbiAgICBnZXRDdXN0b21lckFwcG9pbnRtZW50KCkge1xuICAgICAgICByZXR1cm4gIE9ic2VydmFibGUub2YodGhpcy5jdXN0b21lckFwcG9pbnRtZW50KVxuICAgIH1cblxuICAgIGFkZFNlcnZpY2VTZWxlY3Rpb24oc2VydmljZVNlbGVjdGlvbikge1xuICAgICAgICB0aGlzLnNlcnZpY2VzU2VsZWN0aW9ucy5wdXNoKHNlcnZpY2VTZWxlY3Rpb24pOyBcbiAgICAgICAgdGhpcy5jdXN0b21lckFwcG9pbnRtZW50LnNlcnZpY2VTZWxlY3Rpb25zLnB1c2goc2VydmljZVNlbGVjdGlvbik7ICAgICAgIFxuICAgIH1cblxuICAgIGdldFNlcnZpY2VzU2VsZWN0aW9ucygpe1xuICAgICAgICBjb25zb2xlLmxvZyhcInRoaXMuc2VsZWN0U2VydmljZS5nZXRTZXJ2aWNlc1NlbGVjdGlvbnMoKVwiLCB0aGlzLnNlcnZpY2VzU2VsZWN0aW9ucylcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VydmljZXNTZWxlY3Rpb25zO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXJ2aWNlU2VsZWN0aW9uKHNlcnZpY2VJRCwgdXVpZCkge1xuICAgICAgICB0aGlzLnNlcnZpY2VJRCA9IHNlcnZpY2VJRDtcbiAgICAgICAgdGhpcy5hcHBvaW50bWVudGlkID0gdXVpZDtcbiAgICAgICAgbGV0IHNlcnZpY2VpZCA9IFVVSUQuVVVJRCgpO1xuICAgICAgICBsZXQgc2VydmljZUJvZHkgPSB7XG4gICAgICAgICAgICBcImlkXCI6IHNlcnZpY2VpZCxcbiAgICAgICAgICAgIFwic3RhdHVzXCI6IFwicGVuZGluZ1wiLFxuICAgICAgICAgICAgXCJzZXJ2aWNlXCI6IHRoaXMuc2VydmljZUlEXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXJ2aWNlc1NlbGVjdGlvbnMucHVzaChzZXJ2aWNlQm9keSk7XG4gICAgICAgIHRoaXMuY3VzdG9tZXJBcHBvaW50bWVudC5zZXJ2aWNlU2VsZWN0aW9ucyA9IHRoaXMuc2VydmljZXNTZWxlY3Rpb25zOyBcbiAgICAgICAgQXBwbGljYXRpb25TZXR0aW5ncy5zZXRTdHJpbmcoXCJzZXJ2aWNlc1NlbGVjdGlvbnNcIixKU09OLnN0cmluZ2lmeSh0aGlzLnNlcnZpY2VzU2VsZWN0aW9ucykgKVxuICAgICAgIH1cblxuICAgIHB1YmxpYyB2ZWhpY2xlQWRkKCApIHtcbiAgICAgICAgICAgIGxldCB2ZWhpY2xlVVVJRCA9IFVVSUQuVVVJRCgpO1xuICAgICAgICAgICAgbGV0IHZlaGljbGVhZGRVUkwgPSBcImh0dHBzOi8vdWF0LmZ1dHVyZWRtcy5jb20vc2h5ZnQtYXBpL2FwcG9pbnRtZW50L1wiICsgdGhpcy5hcHBvaW50bWVudGlkICsgXCIvdmVoaWNsZVwiO1xuICAgICAgICAgICAgLy8gaWYgKGlzSU9TKSB7ICAgICBcbiAgICAgICAgICAgIC8vICAgICB0aGlzLmlkX3Rva2VuID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJJT1NUb2tlblwiKVxuICAgICAgICAgICAgLy8gICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gZWxzZVxuICAgICAgICAgICAgLy8ge1xuICAgICAgICAgICAgLy8gICAgIHRoaXMuaWRfdG9rZW4gPSBKU09OLnBhcnNlKEFwcGxpY2F0aW9uU2V0dGluZ3MuZ2V0U3RyaW5nKFwiVE9LRU5cIixcInt9XCIpKSAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgdGhpcy5pZF90b2tlbiA9IEpTT04ucGFyc2UoQXBwbGljYXRpb25TZXR0aW5ncy5nZXRTdHJpbmcoXCJUT0tFTlwiLFwie31cIikpICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoKTtcbiAgICAgICAgICAgIGxldCBkYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgICAgIGxldCBpc29EYXRlID0gZGF0ZS50b0lTT1N0cmluZygpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCIgdGhpcyBpcyBteSBpc28gZGF0ZSAtLS0tLS0+IFwiLCBpc29EYXRlKVxuICAgICAgICAgICAgbGV0ICB2ZWhpY2xlYWRkID17IFxuICAgICAgICAgICAgICAgIFwiaWRcIjp2ZWhpY2xlVVVJRCxcbiAgICAgICAgICAgICAgICBcInZlaGljbGVJZFwiOkpTT04ucGFyc2UoQXBwbGljYXRpb25TZXR0aW5ncy5nZXRTdHJpbmcoXCJ2ZWhpY2xlaWRcIikpLFxuICAgICAgICAgICAgICAgIFwibWlsZXNcIjoxMjNcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwidmVoaWNsZWFkZCBjcmVhdGUgdXJsIC0tPiBcIix2ZWhpY2xlYWRkVVJMKSAgICAgICAgXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInZlaGljbGVhZGQgUFVUIERhdGEgVGVzdGluZy0tLS0tPiBcIiwgSlNPTi5zdHJpbmdpZnkodmVoaWNsZWFkZCkpO1xuICAgICAgICAgICAgaGVhZGVycy5hcHBlbmQoXCJBdXRob3JpemF0aW9uXCIsIHRoaXMuaWRfdG9rZW4pO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQoXG4gICAgICAgICAgICAgICAgICAgICAgICB2ZWhpY2xlYWRkVVJMLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmVoaWNsZWFkZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHsgaGVhZGVyczogaGVhZGVycyB9XG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVmVoaWNsZSBBZGQgU3VjY2VzcyAtLS0tLS0tLS0tLS0+IFwiLCBKU09OLnN0cmluZ2lmeShyZXN1bHQpKVxuICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJWZWhpY2xlIEFkZCBFcnJvciAtLS0tLS0tLS0tLS0+XCIsIGVycm9yKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgXG59XG4iXX0=